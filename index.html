<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#6a0dad"/>
  <title>Inventaris Barang - CYBER</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;700;900&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0q9aSR1-MZkbJ0woYiqQI6il6oeoEWUo",
      authDomain: "inventory-2ab17.firebaseapp.com",
      projectId: "inventory-2ab17",
      storageBucket: "inventory-2ab17.firebasestorage.app",
      messagingSenderId: "1085281663088",
      appId: "1:1085281663088:web:a65f8c29b07a224ccf9cb5",
      measurementId: "G-0PKKSLJ6TB"
    };

    let app;
    try { app = firebase.initializeApp(firebaseConfig); } 
    catch (e) { if (!firebase.apps.length) app = firebase.initializeApp(firebaseConfig); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: 'select_account' });
  </script>

  <style>
    /* --- VARIABLES & PALETTE --- */
    :root {
        --bg-color: #e0e0e0;
        --main-black: #0a0a0a;
        --card-bg: #ffffff;
        
        /* PALET WARNA BARU (NO MORE PINK) */
        --accent-primary: #6a0dad;  /* Deep Electric Violet */
        --accent-secondary: #ccff00; /* Toxic Lime */
        --accent-tertiary: #ff5f00;  /* Industrial Orange */
        
        --border-width: 3px;
        --font-head: 'Space Grotesk', sans-serif;
        --font-mono: 'JetBrains Mono', monospace;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
        font-family: var(--font-head);
        background-color: var(--bg-color);
        color: var(--main-black);
        min-height: 100vh;
        overflow-x: hidden;
        padding-bottom: 20px;
        background-image: 
            linear-gradient(rgba(0,0,0,0.03) 1px, transparent 1px),
            linear-gradient(90deg, rgba(0,0,0,0.03) 1px, transparent 1px);
        background-size: 20px 20px;
        position: relative;
    }

    /* --- DECORATION & NOISE --- */
    .bg-noise {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        opacity: 0.04;
        pointer-events: none;
        z-index: -1;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1IiBoZWlnaHQ9IjUiPgo8cmVjdCB3aWR0aD0iNSIgaGVpZ2h0PSI1IiBmaWxsPSIjZmZmIi8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMwMDAiLz4KPC9zdmc+');
    }

    .floating-shape {
        position: fixed;
        z-index: -2;
        border: 2px solid var(--main-black);
        background: var(--accent-secondary);
        opacity: 0.6;
    }
    .shape-1 { width: 100px; height: 100px; top: 10%; left: -20px; border-radius: 50%; }
    .shape-2 { width: 150px; height: 150px; bottom: 20%; right: -40px; transform: rotate(45deg); background: var(--accent-primary); }

    /* --- NAVIGATION BAR (BOTTOM) --- */
    .bottom-nav {
        position: fixed;
        bottom: 0;
        left: 0;
        width: 100%;
        background: var(--main-black);
        border-top: 3px solid var(--accent-secondary);
        display: flex;
        justify-content: space-around;
        align-items: center;
        padding: 8px 0;
        z-index: 1000;
    }

    .nav-item {
        flex: 1;
        display: flex;
        flex-direction: column;
        align-items: center;
        color: #fff;
        font-size: 0.7rem;
        font-weight: bold;
        cursor: pointer;
        padding: 5px 0;
        transition: all 0.2s;
        font-family: var(--font-head);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-right: 1px solid rgba(255,255,255,0.2);
    }

    .nav-item:last-child {
        border-right: none;
    }

    .nav-item i {
        font-size: 1.3rem;
        margin-bottom: 2px;
        color: var(--accent-secondary);
    }

    .nav-item.active {
        background: var(--accent-primary);
    }

    .nav-item.active i {
        color: white;
    }

    /* --- MARQUEE TOP --- */
    .marquee-top {
        background: var(--main-black);
        color: var(--card-bg);
        padding: 8px 0;
        font-family: var(--font-mono);
        font-size: 0.7rem;
        font-weight: bold;
        border-bottom: var(--border-width) solid var(--accent-secondary);
        overflow: hidden;
        white-space: nowrap;
        position: fixed;
        top: 0;
        width: 100%;
        z-index: 999;
    }
    .marquee-content { display: inline-block; animation: scrollLeft 20s linear infinite; }
    .marquee-content span { margin-right: 25px; }
    .marquee-content i { margin: 0 8px; color: var(--accent-secondary); }
    @keyframes scrollLeft { from { transform: translateX(0); } to { transform: translateX(-50%); } }

    /* --- MAIN CONTENT AREA --- */
    .main-content {
        margin-top: 50px;
        margin-bottom: 70px;
        padding: 15px;
    }

    /* --- CONTAINER & CARD --- */
    .container { max-width: 1200px; margin: 0 auto; width: 100%; }

    .cyber-card {
        background: var(--card-bg);
        border: var(--border-width) solid var(--main-black);
        box-shadow: 8px 8px 0 var(--main-black);
        position: relative;
        overflow: hidden;
        margin-bottom: 20px;
    }

    /* Dekorasi Sekrup */
    .screw { position: absolute; font-family: monospace; font-weight: bold; font-size: 1.2rem; pointer-events: none; color: rgba(0,0,0,0.2); }
    .top-left { top: 5px; left: 10px; } .top-right { top: 5px; right: 10px; }
    .bottom-left { bottom: 5px; left: 10px; } .bottom-right { bottom: 5px; right: 10px; }

    /* HEADER VISUAL */
    .card-header-visual {
        background: var(--accent-primary);
        padding: 15px;
        border-bottom: var(--border-width) solid var(--main-black);
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .profile-section { display: flex; align-items: center; gap: 12px; }

    /* AVATAR STYLING */
    .avatar-img {
        width: 45px; height: 45px;
        border: 3px solid var(--main-black);
        background: #fff;
        border-radius: 12px;
        box-shadow: 4px 4px 0 var(--accent-secondary);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.3rem;
    }

    .profile-info { display: flex; flex-direction: column; }
    .user-role { font-family: var(--font-mono); font-size: 0.65rem; color: var(--accent-secondary); font-weight: bold; letter-spacing: 1px; }
    .user-action { font-weight: 900; color: #fff; font-size: 1rem; text-transform: uppercase; line-height: 1.1; }

    .decor-lines { font-family: var(--font-mono); color: rgba(255,255,255,0.3); font-weight: 900; font-size: 1.2rem; letter-spacing: -2px; }

    /* --- INPUT SECTION --- */
    .card-body { padding: 20px; }
    .input-wrapper { position: relative; margin-bottom: 15px; }
    .input-label { font-family: var(--font-mono); font-weight: bold; font-size: 0.75rem; margin-bottom: 5px; display: block; }

    .cyber-input {
        width: 100%; padding: 12px;
        border: 3px solid var(--main-black);
        background: #f4f4f4;
        font-family: var(--font-mono); font-size: 0.9rem; font-weight: bold;
        outline: none; transition: 0.2s;
    }
    .cyber-input:focus { background: #fff; border-color: var(--accent-tertiary); }

    /* --- BUTTON UTAMA --- */
    .cyber-button {
        width: 100%; padding: 12px;
        border: 3px solid var(--main-black);
        background: var(--accent-secondary);
        color: var(--main-black);
        font-family: var(--font-head); font-weight: 900; font-size: 1rem;
        text-transform: uppercase; cursor: pointer;
        position: relative; overflow: hidden;
        box-shadow: 5px 5px 0 var(--main-black);
        transition: all 0.1s;
        margin-bottom: 8px;
    }
    .cyber-button:active { transform: translate(3px, 3px); box-shadow: 2px 2px 0 var(--main-black); }
    .cyber-button:hover { background: #bfff00; }
    .cyber-button.secondary { background: #fff; }
    .cyber-button.google { background: #ff6b6b; color: white; }
    .cyber-button.danger { background: var(--accent-tertiary); }
    .cyber-button.small {
        padding: 8px 12px;
        font-size: 0.8rem;
        width: auto;
        margin-bottom: 0;
    }

    /* --- PAGE SECTIONS --- */
    .page-section {
        display: none;
    }
    .page-section.active {
        display: block;
    }

    /* --- TABLE STYLING --- */
    .table-container {
        background: var(--card-bg);
        border: var(--border-width) solid var(--main-black);
        box-shadow: 8px 8px 0 var(--main-black);
        overflow: hidden;
        margin-bottom: 20px;
    }

    .table-header {
        background: var(--main-black);
        color: white;
        padding: 12px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: var(--border-width) solid var(--accent-secondary);
    }

    .table-header h2 {
        font-size: 1rem;
        display: flex;
        align-items: center;
        gap: 8px;
        font-family: var(--font-head);
    }

    .table-actions {
        display: flex;
        gap: 6px;
    }

    .table-wrapper {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 600px;
        font-family: var(--font-mono);
        font-size: 0.8rem;
    }

    th {
        background: #f0f0f0;
        padding: 10px 6px;
        text-align: left;
        border-bottom: 3px solid var(--main-black);
        font-weight: 900;
        text-transform: uppercase;
        font-size: 0.75rem;
    }

    td {
        padding: 8px 6px;
        border-bottom: 2px solid #ddd;
    }

    tr:hover td {
        background: rgba(106, 13, 173, 0.05);
    }

    .col-harga, .col-total {
        text-align: right;
        font-weight: 700;
    }

    .col-harga { color: var(--accent-primary); }
    .col-total { color: var(--accent-tertiary); }

    /* ACTION BUTTONS */
    .btn-action {
        width: 30px; height: 30px;
        border: 2px solid var(--main-black);
        background: white;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        margin: 0 2px;
        font-size: 0.8rem;
    }
    .btn-edit { color: var(--accent-primary); }
    .btn-edit:hover { background: var(--accent-primary); color: white; }
    .btn-delete { color: var(--accent-tertiary); }
    .btn-delete:hover { background: var(--accent-tertiary); color: white; }

    /* CUSTOM CHECKBOX */
    .custom-checkbox {
        width: 22px; height: 22px;
        border: 2px solid var(--main-black);
        background: white;
        cursor: pointer;
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
    .custom-checkbox.checked { background: var(--accent-tertiary); }
    .custom-checkbox i { color: white; font-size: 12px; display: none; }
    .custom-checkbox.checked i { display: block; }

    /* BULK ACTION BAR */
    .bulk-action-bar {
        background: var(--accent-tertiary);
        color: white;
        padding: 8px 12px;
        border-bottom: var(--border-width) solid var(--main-black);
        display: none;
        justify-content: space-between;
        align-items: center;
    }
    .bulk-action-bar.show { display: flex; }
    .bulk-info { font-weight: bold; font-size: 0.8rem; }
    .bulk-btn {
        background: white; color: var(--main-black); border: 2px solid var(--main-black);
        padding: 4px 12px; font-weight: 800; cursor: pointer;
        font-family: var(--font-head); font-size: 0.75rem;
    }

    /* FAB BUTTON */
    #fabButton {
        position: fixed; bottom: 80px; right: 15px; width: 55px; height: 55px;
        background: var(--accent-secondary); color: var(--main-black);
        border: 3px solid var(--main-black);
        display: none; align-items: center; justify-content: center;
        font-size: 1.6rem; font-weight: bold;
        box-shadow: 5px 5px 0 var(--main-black); cursor: pointer;
        z-index: 100; border-radius: 50%;
    }
    #fabButton.show { display: flex !important; }
    #fabButton:active { transform: translate(3px, 3px); box-shadow: 2px 2px 0 var(--main-black); }

    /* MODAL */
    .modal-backdrop {
        display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.8); z-index: 1001; justify-content: center; align-items: center;
        padding: 15px;
    }
    .modal, .modal-confirm {
        background: var(--card-bg); border: 3px solid var(--main-black);
        box-shadow: 10px 10px 0 var(--main-black);
        width: 95%; max-width: 450px; max-height: 85vh; overflow-y: auto;
        padding: 18px; position: relative;
    }
    .modal-confirm { max-width: 350px; text-align: center; }
    .modal-header {
        display: flex; justify-content: space-between; align-items: center;
        margin-bottom: 12px; padding-bottom: 8px; border-bottom: 3px solid var(--main-black);
    }
    .modal-title { font-size: 1.1rem; font-weight: 900; font-family: var(--font-head); }
    .modal-close {
        background: var(--accent-tertiary); color: white; border: 2px solid var(--main-black);
        width: 28px; height: 28px; display: flex; align-items: center; justify-content: center;
        cursor: pointer; font-weight: bold; font-size: 0.9rem;
    }

    /* ACCOUNT PAGE */
    .account-card {
        background: var(--card-bg); border: 3px solid var(--main-black);
        box-shadow: 8px 8px 0 var(--main-black); padding: 18px;
    }
    .account-avatar {
        width: 70px; height: 70px; border: 3px solid var(--main-black);
        background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
        color: var(--main-black); display: flex; align-items: center; justify-content: center;
        font-size: 1.8rem; margin: 0 auto 12px; border-radius: 15px;
        box-shadow: 5px 5px 0 var(--main-black);
    }
    .account-info {
        background: #f5f5f5; border: 2px solid var(--main-black);
        padding: 12px; margin: 12px 0;
    }
    .account-info p { margin: 6px 0; font-family: var(--font-mono); font-size: 0.85rem; }

    /* KALKULATOR PAGE */
    .calculator-card {
        background: var(--card-bg); border: 3px solid var(--main-black);
        box-shadow: 8px 8px 0 var(--main-black); padding: 18px;
    }
    .calc-display {
        background: var(--main-black); color: var(--accent-secondary);
        font-size: 1.6rem; padding: 12px; border: 3px solid var(--accent-primary);
        text-align: right; margin-bottom: 12px; font-family: var(--font-mono);
        font-weight: bold;
    }
    .calc-expression { color: #888; font-size: 0.8rem; text-align: right; }
    .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .calc-btn {
        padding: 12px; font-size: 1rem; font-weight: 800;
        border: 3px solid var(--main-black); background: #fff;
        cursor: pointer; font-family: var(--font-head);
    }
    .calc-btn.operator { background: var(--accent-primary); color: white; }
    .calc-btn.equals { background: var(--accent-secondary); color: var(--main-black); grid-column: span 2; }
    .calc-btn.clear { background: var(--accent-tertiary); color: white; }
    .calc-history {
        margin-top: 12px; border: 2px solid var(--main-black);
        padding: 8px; max-height: 90px; overflow-y: auto;
        font-family: var(--font-mono); font-size: 0.8rem;
    }

    /* AUTH PAGES */
    #authPage, #forgotPasswordPage, #resetPasswordPage {
        max-width: 400px;
        margin: 20px auto;
    }

    /* EMPTY STATE */
    .empty-state {
        text-align: center; padding: 25px; color: #666;
        font-family: var(--font-mono);
    }

    /* NOTIFICATION */
    #notification {
        position: fixed; top: 60px; right: 15px; padding: 10px 18px;
        border: 3px solid var(--main-black); font-weight: 900;
        box-shadow: 5px 5px 0 var(--main-black);
        transform: translateX(200%); transition: transform 0.3s;
        z-index: 1002; max-width: 90%;
        font-family: var(--font-head); font-size: 0.85rem;
    }
    #notification.show { transform: translateX(0); }
    .notif-success { background: var(--accent-secondary); color: var(--main-black); }
    .notif-error { background: var(--accent-tertiary); color: white; }
    .notif-warning { background: var(--accent-primary); color: white; }

    /* SCREW DECORATION FOR CARDS */
    .cyber-card, .modal, .modal-confirm, .account-card, .calculator-card {
        position: relative;
    }
    .cyber-card::before, .modal::before, .modal-confirm::before {
        content: 'â¬¤'; position: absolute; top: 5px; left: 10px;
        font-size: 10px; color: rgba(0,0,0,0.3); pointer-events: none;
    }
    .cyber-card::after, .modal::after, .modal-confirm::after {
        content: 'â¬¤'; position: absolute; bottom: 5px; right: 10px;
        font-size: 10px; color: rgba(0,0,0,0.3); pointer-events: none;
    }

    /* RESPONSIVE */
    @media (max-width: 480px) {
        .main-content { padding: 10px; }
        .nav-item i { font-size: 1.2rem; }
        .nav-item span { font-size: 0.6rem; }
        .cyber-button { font-size: 0.9rem; padding: 10px; }
        .table-header { flex-direction: column; align-items: flex-start; gap: 8px; }
        .table-actions { width: 100%; }
    }
  </style>
</head>
<body>
  <!-- DECORATIONS -->
  <div class="bg-noise"></div>
  <div class="floating-shape shape-1"></div>
  <div class="floating-shape shape-2"></div>

  <!-- MARQUEE TOP -->
  <div class="marquee-top">
    <div class="marquee-content">
      <span><i class="fas fa-bolt"></i> INVENTARIS BARANG </span>
      <span><i class="fas fa-cube"></i> TRACKING INVENTORY </span>
      <span><i class="fas fa-chart-line"></i> REALTIME DATA </span>
      <span><i class="fas fa-bolt"></i> INVENTARIS BARANG CYBER </span>
      <span><i class="fas fa-cube"></i> TRACKING INVENTORY </span>
    </div>
  </div>

  <!-- BOTTOM NAVIGATION -->
  <div class="bottom-nav" id="bottomNav">
    <div class="nav-item active" data-page="dataBarang">
      <i class="fas fa-box"></i>
      <span>DATA</span>
    </div>
    <div class="nav-item" data-page="akumulasi">
      <i class="fas fa-chart-pie"></i>
      <span>SUMMARY</span>
    </div>
    <div class="nav-item" data-page="kalkulator">
      <i class="fas fa-calculator"></i>
      <span>CALC</span>
    </div>
    <div class="nav-item" data-page="account">
      <i class="fas fa-user-circle"></i>
      <span>ACCOUNT</span>
    </div>
  </div>

  <!-- MAIN CONTENT -->
  <div class="main-content">
    <!-- AUTH PAGES (akan ditampilkan jika belum login) -->
    <div id="authPage" class="container">
      <div class="cyber-card">
        <div class="card-header-visual">
          <div class="profile-section">
            <div class="avatar-img"><i class="fas fa-user-lock"></i></div>
            <div class="profile-info">
              <span class="user-role">ACCESS PORTAL</span>
              <span class="user-action">AUTHENTICATION</span>
            </div>
          </div>
          <div class="decor-lines">///</div>
        </div>
        <div class="card-body">
          <div style="display: flex; gap: 0.8rem; margin-bottom: 1.2rem;">
            <button id="tabLogin" class="cyber-button" style="margin:0;" onclick="showTab('login')">LOGIN</button>
            <button id="tabSignup" class="cyber-button secondary" style="margin:0;" onclick="showTab('signup')">SIGNUP</button>
          </div>
          
          <div id="loginForm">
            <div class="input-wrapper">
              <label class="input-label">ðŸ“§ EMAIL</label>
              <input type="email" id="emailLogin" class="cyber-input" placeholder="user@domain.com">
            </div>
            <div class="input-wrapper">
              <label class="input-label">ðŸ”‘ PASSWORD</label>
              <input type="password" id="passwordLogin" class="cyber-input" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="cyber-button" onclick="loginWithEmail()">LOGIN</button>
            <button class="cyber-button secondary" onclick="forgotPassword()">FORGOT PASSWORD?</button>
            <button class="cyber-button google" onclick="signInWithGoogle()">GOOGLE LOGIN</button>
          </div>
          
          <div id="signupForm" style="display: none;">
            <div class="input-wrapper">
              <label class="input-label">ðŸ“§ EMAIL</label>
              <input type="email" id="emailSignup" class="cyber-input" placeholder="user@domain.com">
            </div>
            <div class="input-wrapper">
              <label class="input-label">ðŸ”‘ PASSWORD</label>
              <input type="password" id="passwordSignup" class="cyber-input" placeholder="Min 6 chars">
            </div>
            <div class="input-wrapper">
              <label class="input-label">âœ… CONFIRM</label>
              <input type="password" id="confirmPassword" class="cyber-input" placeholder="Re-type password">
            </div>
            <button class="cyber-button" onclick="signUpWithEmail()">CREATE ACCOUNT</button>
          </div>
        </div>
      </div>
    </div>

    <!-- FORGOT PASSWORD PAGE -->
    <div id="forgotPasswordPage" class="container" style="display: none;">
      <div class="cyber-card">
        <div class="card-header-visual">
          <div class="profile-section">
            <div class="avatar-img"><i class="fas fa-key"></i></div>
            <div class="profile-info">
              <span class="user-role">RECOVERY</span>
              <span class="user-action">RESET PASSWORD</span>
            </div>
          </div>
          <div class="decor-lines">///</div>
        </div>
        <div class="card-body">
          <div class="input-wrapper">
            <label class="input-label">ðŸ“§ EMAIL</label>
            <input type="email" id="fpEmail" class="cyber-input" placeholder="user@domain.com">
          </div>
          <button class="cyber-button" onclick="sendPasswordResetLink()">SEND RESET LINK</button>
          <button class="cyber-button secondary" onclick="showAuthPage()">BACK TO LOGIN</button>
        </div>
      </div>
    </div>

    <!-- RESET PASSWORD PAGE -->
    <div id="resetPasswordPage" class="container" style="display: none;">
      <div class="cyber-card">
        <div class="card-header-visual">
          <div class="profile-section">
            <div class="avatar-img"><i class="fas fa-lock-open"></i></div>
            <div class="profile-info">
              <span class="user-role">NEW PASSWORD</span>
              <span class="user-action">SET NEW</span>
            </div>
          </div>
          <div class="decor-lines">///</div>
        </div>
        <div class="card-body">
          <div class="input-wrapper">
            <label class="input-label">ðŸ”‘ NEW PASSWORD</label>
            <input type="password" id="newPassword" class="cyber-input" placeholder="Min 6 chars">
          </div>
          <div class="input-wrapper">
            <label class="input-label">âœ… CONFIRM</label>
            <input type="password" id="confirmNewPassword" class="cyber-input" placeholder="Re-type password">
          </div>
          <button class="cyber-button" onclick="confirmPasswordReset()">UPDATE PASSWORD</button>
          <button class="cyber-button secondary" onclick="showAuthPage()">CANCEL</button>
        </div>
      </div>
    </div>

    <!-- MAIN APP PAGES (akan ditampilkan setelah login) -->
    <div id="app" style="display: none;">
      <!-- DATA BARANG PAGE -->
      <div id="dataBarangPage" class="page-section active">
        <div class="cyber-card" style="margin-bottom: 15px;">
          <div class="card-header-visual">
            <div class="profile-section">
              <div class="avatar-img" id="userAvatar"><i class="fas fa-user"></i></div>
              <div class="profile-info">
                <span class="user-role">INVENTORY SYSTEM</span>
                <span class="user-action" id="userDisplayName">LOADING...</span>
              </div>
            </div>
            <div class="decor-lines">///</div>
          </div>
        </div>

        <div class="table-container">
          <div id="bulkActionBar" class="bulk-action-bar">
            <div class="bulk-info"><i class="fas fa-check-circle"></i> <span id="bulkCount">0</span> SELECTED</div>
            <button class="bulk-btn" onclick="deleteSelected()"><i class="fas fa-trash"></i> DELETE</button>
          </div>
          <div class="table-header">
            <h2><i class="fas fa-clipboard-list"></i> INVENTORY DATA</h2>
            <div class="table-actions">
              <button class="cyber-button small" style="background: var(--accent-secondary);" onclick="downloadCSV()">CSV</button>
              <button class="cyber-button small" style="background: var(--accent-primary); color: white;" onclick="exportToPNG()">PNG</button>
            </div>
          </div>
          <div class="table-wrapper">
            <table id="dataTable">
              <thead>
                <tr>
                  <th style="width:35px;"><div class="custom-checkbox" onclick="toggleSelectAll()" id="selectAllCheckbox"><i class="fas fa-check"></i></div></th>
                  <th>NO</th><th>ITEM</th><th>QTY</th><th>PRICE</th><th>TOTAL</th><th>DATE</th><th>ACTIONS</th>
                </tr>
              </thead>
              <tbody id="dataBody"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- AKUMULASI PAGE -->
      <div id="akumulasiPage" class="page-section">
        <div class="table-container">
          <div class="table-header" style="background: var(--accent-primary);">
            <h2><i class="fas fa-chart-bar"></i> ACCUMULATION SUMMARY</h2>
          </div>
          <div class="table-wrapper">
            <table id="summaryTable">
              <thead><tr><th>ITEM</th><th>TOTAL QTY</th><th>TOTAL VALUE</th></tr></thead>
              <tbody id="summaryBody"></tbody>
              <tfoot id="summaryFooter" style="background: var(--main-black); color: var(--accent-secondary);"></tfoot>
            </table>
          </div>
        </div>
      </div>

      <!-- KALKULATOR PAGE -->
      <div id="kalkulatorPage" class="page-section">
        <div class="calculator-card">
          <h2 style="text-align:center; margin-bottom:12px; font-size:1.1rem;"><i class="fas fa-calculator"></i> CYBER CALCULATOR</h2>
          <div class="calc-expression" id="calcExpression"></div>
          <div class="calc-display" id="calcDisplay">0</div>
          <div class="calc-buttons">
            <button class="calc-btn clear" onclick="calcClear()">AC</button>
            <button class="calc-btn" onclick="calcBackspace()">âŒ«</button>
            <button class="calc-btn operator" onclick="calcInput('%')">%</button>
            <button class="calc-btn operator" onclick="calcInput('Ã·')">Ã·</button>
            <button class="calc-btn" onclick="calcInput('7')">7</button>
            <button class="calc-btn" onclick="calcInput('8')">8</button>
            <button class="calc-btn" onclick="calcInput('9')">9</button>
            <button class="calc-btn operator" onclick="calcInput('Ã—')">Ã—</button>
            <button class="calc-btn" onclick="calcInput('4')">4</button>
            <button class="calc-btn" onclick="calcInput('5')">5</button>
            <button class="calc-btn" onclick="calcInput('6')">6</button>
            <button class="calc-btn operator" onclick="calcInput('-')">âˆ’</button>
            <button class="calc-btn" onclick="calcInput('1')">1</button>
            <button class="calc-btn" onclick="calcInput('2')">2</button>
            <button class="calc-btn" onclick="calcInput('3')">3</button>
            <button class="calc-btn operator" onclick="calcInput('+')">+</button>
            <button class="calc-btn zero" onclick="calcInput('0')">0</button>
            <button class="calc-btn" onclick="calcInput('.')">.</button>
            <button class="calc-btn equals" onclick="calcCalculate()">=</button>
          </div>
          <div class="calc-history" id="calcHistory"></div>
        </div>
      </div>

      <!-- ACCOUNT PAGE -->
      <div id="accountPage" class="page-section">
        <div class="account-card">
          <div class="account-avatar" id="accountAvatar"><i class="fas fa-user"></i></div>
          <h2 id="accountName" style="text-align:center;">User</h2>
          <p style="color: var(--accent-primary); text-align:center;" id="accountEmail">email</p>
          <div class="account-info">
            <p><i class="fas fa-calendar"></i> Joined: <span id="accountJoined">-</span></p>
            <p><i class="fas fa-database"></i> Total Items: <span id="accountTotalData">0</span></p>
          </div>
          <div style="display: flex; gap: 8px; justify-content: center;">
            <button class="cyber-button secondary" style="width: auto; padding: 8px 12px; font-size:0.8rem;" onclick="changePassword()">CHANGE PASSWORD</button>
            <button class="cyber-button danger" style="width: auto; padding: 8px 12px; font-size:0.8rem;" onclick="deleteAccount()">DELETE ACCOUNT</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- FAB BUTTON (untuk tambah data) -->
  <div id="fabButton" onclick="openAddModal()"><i class="fas fa-plus"></i></div>

  <!-- MODALS -->
  <div id="addModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-plus-circle" style="color: var(--accent-secondary);"></i> ADD ITEM</div>
        <button class="modal-close" onclick="closeModal('addModal')">X</button>
      </div>
      <div class="input-wrapper">
        <label class="input-label">ITEM NAME</label>
        <input type="text" id="namaBarangInput" class="cyber-input">
      </div>
      <div class="input-wrapper">
        <label class="input-label">QUANTITY</label>
        <input type="number" id="jumlahInput" class="cyber-input" min="1">
      </div>
      <div class="input-wrapper">
        <label class="input-label">PRICE</label>
        <input type="number" id="hargaInput" class="cyber-input" min="0">
      </div>
      <div class="input-wrapper">
        <label class="input-label">DATE</label>
        <input type="date" id="tanggalInput" class="cyber-input">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="cyber-button" style="margin:0;" onclick="tambahData()">SAVE</button>
        <button class="cyber-button secondary" style="margin:0;" onclick="closeModal('addModal')">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="editModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-edit" style="color: var(--accent-primary);"></i> EDIT ITEM</div>
        <button class="modal-close" onclick="closeModal('editModal')">X</button>
      </div>
      <input type="hidden" id="editIndex">
      <div class="input-wrapper">
        <label class="input-label">ITEM NAME</label>
        <input type="text" id="editNama" class="cyber-input">
      </div>
      <div class="input-wrapper">
        <label class="input-label">QUANTITY</label>
        <input type="number" id="editJumlah" class="cyber-input" min="1">
      </div>
      <div class="input-wrapper">
        <label class="input-label">PRICE</label>
        <input type="number" id="editHarga" class="cyber-input" min="0">
      </div>
      <div class="input-wrapper">
        <label class="input-label">DATE</label>
        <input type="date" id="editTanggal" class="cyber-input">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="cyber-button" style="margin:0;" onclick="updateData()">UPDATE</button>
        <button class="cyber-button secondary" style="margin:0;" onclick="closeModal('editModal')">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="confirmModal" class="modal-backdrop">
    <div class="modal-confirm">
      <div class="modal-title" style="color: var(--accent-tertiary);">DELETE ITEM?</div>
      <p style="margin:15px 0; font-family: var(--font-mono); font-size:0.9rem;">This action cannot be undone!</p>
      <div style="display:flex;gap:8px; justify-content: center;">
        <button class="cyber-button secondary" style="width: auto; margin:0; padding:8px 15px;" onclick="closeModal('confirmModal')">CANCEL</button>
        <button class="cyber-button danger" style="width: auto; margin:0; padding:8px 15px;" onclick="confirmDelete()">DELETE</button>
      </div>
    </div>
  </div>

  <div id="confirmBulkModal" class="modal-backdrop">
    <div class="modal-confirm">
      <div class="modal-title" style="color: var(--accent-tertiary);">DELETE <span id="bulkConfirmCount">0</span> ITEMS?</div>
      <p style="margin:15px 0; font-family: var(--font-mono); font-size:0.9rem;">This action cannot be undone!</p>
      <div style="display:flex;gap:8px; justify-content: center;">
        <button class="cyber-button secondary" style="width: auto; margin:0; padding:8px 15px;" onclick="closeModal('confirmBulkModal')">CANCEL</button>
        <button class="cyber-button danger" style="width: auto; margin:0; padding:8px 15px;" onclick="confirmBulkDelete()">DELETE</button>
      </div>
    </div>
  </div>

  <div id="changePasswordModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title"><i class="fas fa-key" style="color: var(--accent-primary);"></i> CHANGE PASSWORD</div>
        <button class="modal-close" onclick="closeModal('changePasswordModal')">X</button>
      </div>
      <div class="input-wrapper">
        <label class="input-label">OLD PASSWORD</label>
        <input type="password" id="oldPassword" class="cyber-input">
      </div>
      <div class="input-wrapper">
        <label class="input-label">NEW PASSWORD</label>
        <input type="password" id="newPasswordAccount" class="cyber-input">
      </div>
      <div class="input-wrapper">
        <label class="input-label">CONFIRM NEW</label>
        <input type="password" id="confirmNewPasswordAccount" class="cyber-input">
      </div>
      <div style="display:flex;gap:8px;">
        <button class="cyber-button" style="margin:0;" onclick="submitChangePassword()">UPDATE</button>
        <button class="cyber-button secondary" style="margin:0;" onclick="closeModal('changePasswordModal')">CANCEL</button>
      </div>
    </div>
  </div>

  <div id="notification"></div>

  <script>
    // Semua fungsi JavaScript tetap sama
    let currentUser = null, barangData = [], deleteIndex = null, currentPage = 'dataBarang';
    let selectedIndices = new Set();
    let calcCurrent = '0', calcPrevious = '', calcOperator = null, calcShouldReset = false, calcHistory = [];

    // Page navigation
    function switchPage(pageName) {
      // Update active class on nav items
      document.querySelectorAll('.nav-item').forEach(item => {
        if (item.dataset.page === pageName) {
          item.classList.add('active');
        } else {
          item.classList.remove('active');
        }
      });

      // Update active page section
      document.querySelectorAll('.page-section').forEach(section => {
        section.classList.remove('active');
      });
      document.getElementById(pageName + 'Page').classList.add('active');

      // Show/hide FAB button (only show on dataBarang page)
      document.getElementById('fabButton').classList.toggle('show', pageName === 'dataBarang');
      
      currentPage = pageName;
      
      // Refresh data if needed
      if (pageName === 'akumulasi') renderSummaryTable();
      if (pageName === 'account') updateAccountInfo();
    }

    function showTab(tab) {
      document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
      document.getElementById('tabLogin').classList.toggle('secondary', tab !== 'login');
      document.getElementById('tabSignup').classList.toggle('secondary', tab !== 'signup');
    }

    function showAuthPage() {
      document.getElementById('authPage').style.display = 'block';
      document.getElementById('forgotPasswordPage').style.display = 'none';
      document.getElementById('resetPasswordPage').style.display = 'none';
      document.getElementById('app').style.display = 'none';
      document.getElementById('fabButton').classList.remove('show');
    }

    async function signUpWithEmail() {
      const email = document.getElementById('emailSignup').value.trim();
      const pass = document.getElementById('passwordSignup').value;
      const pass2 = document.getElementById('confirmPassword').value;
      if (!email || !pass) return showNotification('Email & password wajib!', 'warning');
      if (pass !== pass2) return showNotification('Password tidak cocok!', 'warning');
      if (pass.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
        showNotification('Akun berhasil dibuat!', 'success');
        showTab('login');
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function loginWithEmail() {
      const email = document.getElementById('emailLogin').value.trim();
      const pass = document.getElementById('passwordLogin').value;
      if (!email || !pass) return showNotification('Email & password wajib!', 'warning');
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        showNotification('Selamat datang!', 'success');
        setTimeout(showApp, 600);
        await loadUserData();
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function signInWithGoogle() {
      try {
        const result = await auth.signInWithPopup(googleProvider);
        currentUser = result.user;
        const docRef = db.collection('users').doc(currentUser.uid);
        if (!(await docRef.get()).exists) await docRef.set({ barangData: [] });
        showNotification('Selamat datang!', 'success');
        setTimeout(showApp, 600);
        await loadUserData();
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function logout() {
      await auth.signOut();
      currentUser = null; barangData = []; selectedIndices.clear();
      showNotification('Keluar berhasil', 'success');
      setTimeout(showAuthPage, 500);
    }

    function forgotPassword() {
      const email = document.getElementById('emailLogin').value.trim();
      if (email) document.getElementById('fpEmail').value = email;
      showAuthPage();
      setTimeout(() => {
        document.getElementById('authPage').style.display = 'none';
        document.getElementById('forgotPasswordPage').style.display = 'block';
      }, 300);
    }

    async function sendPasswordResetLink() {
      const email = document.getElementById('fpEmail').value.trim();
      if (!email) return showNotification('Masukkan email!', 'warning');
      try {
        await auth.sendPasswordResetEmail(email);
        showNotification('Tautan dikirim!', 'success');
        setTimeout(showAuthPage, 2000);
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function confirmPasswordReset() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      const oobCode = window.passwordResetCode;
      if (!oobCode) return showNotification('Sesi kadaluarsa!', 'error');
      if (!newPassword || !confirmNewPassword) return showNotification('Semua kolom wajib!', 'warning');
      if (newPassword !== confirmNewPassword) return showNotification('Password tidak cocok!', 'warning');
      if (newPassword.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        await auth.confirmPasswordReset(oobCode, newPassword);
        showNotification('Password diubah!', 'success');
        setTimeout(() => { window.passwordResetCode = null; showAuthPage(); }, 2000);
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function loadUserData() {
      if (!currentUser) return;
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        barangData = doc.exists && doc.data().barangData ? doc.data().barangData : [];
        selectedIndices.clear();
        renderTable();
        renderSummaryTable();
        updateBulkActionBar();
      } catch (e) { showNotification('Gagal memuat data', 'error'); }
    }

    async function saveUserData() {
      if (!currentUser) return;
      try {
        barangData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
        await db.collection('users').doc(currentUser.uid).set({ barangData }, { merge: true });
        renderTable();
        renderSummaryTable();
        updateBulkActionBar();
      } catch (e) { showNotification('Gagal menyimpan', 'error'); }
    }

    function showApp() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('app').style.display = 'block';
      document.getElementById('fabButton').classList.add('show');
      const user = currentUser;
      document.getElementById('userDisplayName').textContent = user.displayName || user.email;
      document.getElementById('userAvatar').innerHTML = user.displayName ? `<i class="fas fa-user"></i>` : `<i class="fas fa-user-circle"></i>`;
      document.getElementById('tanggalInput').valueAsDate = new Date();
      document.getElementById('editTanggal').valueAsDate = new Date();
      updateAccountInfo();
      
      // Set default page
      switchPage('dataBarang');
    }

    function updateAccountInfo() {
      if (!currentUser) return;
      document.getElementById('accountName').textContent = currentUser.displayName || currentUser.email;
      document.getElementById('accountEmail').textContent = currentUser.email;
      document.getElementById('accountJoined').textContent = currentUser.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString('id-ID') : '-';
      document.getElementById('accountTotalData').textContent = barangData.length;
    }

    function openAddModal() {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      document.getElementById('namaBarangInput').value = '';
      document.getElementById('jumlahInput').value = '';
      document.getElementById('hargaInput').value = '';
      document.getElementById('tanggalInput').valueAsDate = new Date();
      document.getElementById('addModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function tambahData() {
      const nama = document.getElementById('namaBarangInput').value.trim();
      const jumlah = parseInt(document.getElementById('jumlahInput').value);
      const harga = parseInt(document.getElementById('hargaInput').value) || 0;
      const tanggal = document.getElementById('tanggalInput').value;
      if (!nama) return showNotification('Nama wajib!', 'warning');
      if (!jumlah || jumlah <= 0) return showNotification('Jumlah harus > 0!', 'warning');
      if (!tanggal) return showNotification('Tanggal wajib!', 'warning');
      barangData.push({ nama, jumlah, harga, tanggal });
      await saveUserData();
      closeModal('addModal');
      showNotification('Data ditambahkan!', 'success');
    }

    async function updateData() {
      const index = parseInt(document.getElementById('editIndex').value);
      const nama = document.getElementById('editNama').value.trim();
      const jumlah = parseInt(document.getElementById('editJumlah').value);
      const harga = parseInt(document.getElementById('editHarga').value) || 0;
      const tanggal = document.getElementById('editTanggal').value;
      if (!nama) return showNotification('Nama wajib!', 'warning');
      if (!jumlah || jumlah <= 0) return showNotification('Jumlah harus > 0!', 'warning');
      if (!tanggal) return showNotification('Tanggal wajib!', 'warning');
      barangData[index] = { nama, jumlah, harga, tanggal };
      await saveUserData();
      closeModal('editModal');
      showNotification('Data diperbarui!', 'success');
    }

    function openConfirmDelete(index) {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      deleteIndex = index;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    async function confirmDelete() {
      if (deleteIndex !== null) {
        barangData.splice(deleteIndex, 1);
        await saveUserData();
        closeModal('confirmModal');
        showNotification('Data dihapus!', 'warning');
        deleteIndex = null;
      }
    }

    function openEditModal(index) {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      const item = barangData[index];
      document.getElementById('editIndex').value = index;
      document.getElementById('editNama').value = item.nama;
      document.getElementById('editJumlah').value = item.jumlah;
      document.getElementById('editHarga').value = item.harga || 0;
      document.getElementById('editTanggal').value = item.tanggal;
      document.getElementById('editModal').style.display = 'flex';
    }

    function toggleSelect(index) {
      selectedIndices.has(index) ? selectedIndices.delete(index) : selectedIndices.add(index);
      renderTable();
      updateBulkActionBar();
    }

    function toggleSelectAll() {
      if (selectedIndices.size === barangData.length && barangData.length > 0) selectedIndices.clear();
      else barangData.forEach((_, i) => selectedIndices.add(i));
      renderTable();
      updateBulkActionBar();
    }

    function updateBulkActionBar() {
      const bar = document.getElementById('bulkActionBar');
      document.getElementById('bulkCount').textContent = selectedIndices.size;
      if (bar) bar.classList.toggle('show', selectedIndices.size > 0);
      const selectAll = document.getElementById('selectAllCheckbox');
      if (selectAll) selectAll.classList.toggle('checked', selectedIndices.size === barangData.length && barangData.length > 0);
    }

    function deleteSelected() {
      if (selectedIndices.size === 0) return;
      document.getElementById('bulkConfirmCount').textContent = selectedIndices.size;
      document.getElementById('confirmBulkModal').style.display = 'flex';
    }

    async function confirmBulkDelete() {
      const indices = Array.from(selectedIndices).sort((a, b) => b - a);
      indices.forEach(i => barangData.splice(i, 1));
      selectedIndices.clear();
      await saveUserData();
      closeModal('confirmBulkModal');
      showNotification(`${indices.length} data dihapus!`, 'success');
    }

    function formatRupiah(angka) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    }

    function renderTable() {
      const tbody = document.getElementById('dataBody');
      if (!barangData || !barangData.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state"><i class="fas fa-inbox"></i><div>No data available</div></td></tr>`;
        return;
      }
      tbody.innerHTML = barangData.map((item, i) => {
        const total = (item.jumlah || 0) * (item.harga || 0);
        const isSelected = selectedIndices.has(i);
        return `<tr style="${isSelected ? 'background: #ffe6e6;' : ''}">
          <td style="text-align:center;"><div class="custom-checkbox ${isSelected ? 'checked' : ''}" onclick="toggleSelect(${i})"><i class="fas fa-check"></i></div></td>
          <td>${i + 1}</td><td><strong>${item.nama}</strong></td><td>${item.jumlah}</td>
          <td class="col-harga">${formatRupiah(item.harga || 0)}</td>
          <td class="col-total">${formatRupiah(total)}</td>
          <td>${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
          <td>
            <button class="btn-action btn-edit" onclick="openEditModal(${i})"><i class="fas fa-edit"></i></button>
            <button class="btn-action btn-delete" onclick="openConfirmDelete(${i})"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
      }).join('');
    }

    function renderSummaryTable() {
      const tbody = document.getElementById('summaryBody');
      const tfoot = document.getElementById('summaryFooter');
      if (!barangData || !barangData.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty-state"><i class="fas fa-chart-pie"></i><div>No data available</div></td></tr>`;
        tfoot.innerHTML = '';
        return;
      }
      const map = {};
      let grandTotal = 0;
      barangData.forEach(item => {
        const key = item.nama.trim().toLowerCase();
        const val = (item.jumlah || 0) * (item.harga || 0);
        grandTotal += val;
        if (!map[key]) map[key] = { nama: item.nama, qty: 0, nilai: 0 };
        map[key].qty += item.jumlah || 0;
        map[key].nilai += val;
      });
      tbody.innerHTML = Object.entries(map).sort((a, b) => a[1].nama.localeCompare(b[1].nama)).map(([_, d]) => 
        `<tr><td><strong>${d.nama}</strong></td><td style="font-weight:900">${d.qty}</td><td class="col-total">${formatRupiah(d.nilai)}</td></tr>`
      ).join('');
      tfoot.innerHTML = `<tr><td><strong>TOTAL</strong></td><td>-</td><td style="color: var(--accent-secondary); font-weight:900;">${formatRupiah(grandTotal)}</td></tr>`;
    }

    function downloadCSV() {
      if (!barangData.length) return showNotification('Tidak ada data!', 'error');
      let csv = 'No,Nama,Jumlah,Harga,Total,Tanggal\n';
      barangData.forEach((item, i) => {
        const total = (item.jumlah || 0) * (item.harga || 0);
        csv += `${i + 1},${item.nama},${item.jumlah},${item.harga || 0},${total},${item.tanggal}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `inventaris_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
      showNotification('File diunduh!', 'success');
    }

    function exportToPNG() {
      if (!barangData.length) return showNotification('Tidak ada data!', 'error');
      const div = document.createElement('div');
      div.style.cssText = 'padding:20px;background:white;position:absolute;left:-9999px;';
      div.innerHTML = `<h2>DAFTAR BARANG</h2>${document.getElementById('dataTable').outerHTML}`;
      document.body.appendChild(div);
      html2canvas(div, { scale: 2 }).then(canvas => {
        const a = document.createElement('a'); a.download = `inventaris_${new Date().toISOString().slice(0,10)}.png`;
        a.href = canvas.toDataURL(); a.click();
        document.body.removeChild(div);
        showNotification('PNG diunduh!', 'success');
      }).catch(() => { showNotification('Gagal membuat PNG', 'error'); document.body.removeChild(div); });
    }

    // Kalkulator functions
    function updateCalcDisplay() {
      document.getElementById('calcDisplay').textContent = calcCurrent;
      document.getElementById('calcExpression').textContent = calcOperator ? `${calcPrevious} ${calcOperator}` : '';
    }

    function calcInput(val) {
      if (calcShouldReset && !['+', '-', 'Ã—', 'Ã·', '%'].includes(val)) { calcCurrent = ''; calcShouldReset = false; }
      if (['+', '-', 'Ã—', 'Ã·', '%'].includes(val)) {
        if (calcOperator && !calcShouldReset) calcCalculate(false);
        calcPrevious = calcCurrent; calcOperator = val; calcShouldReset = true;
      } else if (val === '.') {
        if (!calcCurrent.includes('.')) calcCurrent += '.';
      } else {
        calcCurrent = calcCurrent === '0' ? val : calcCurrent + val;
      }
      updateCalcDisplay();
    }

    function calcClear() { calcCurrent = '0'; calcPrevious = ''; calcOperator = null; calcShouldReset = false; updateCalcDisplay(); }
    function calcBackspace() { calcCurrent = calcCurrent.length > 1 ? calcCurrent.slice(0, -1) : '0'; updateCalcDisplay(); }

    function calcCalculate(updateHistory = true) {
      if (!calcOperator || !calcPrevious) return;
      const a = parseFloat(calcPrevious), b = parseFloat(calcCurrent);
      let res;
      switch(calcOperator) {
        case '+': res = a + b; break;
        case '-': res = a - b; break;
        case 'Ã—': res = a * b; break;
        case 'Ã·': res = b !== 0 ? a / b : 'Error'; break;
        case '%': res = a * (b / 100); break;
      }
      if (updateHistory && res !== 'Error') {
        calcHistory.unshift(`${calcPrevious} ${calcOperator} ${calcCurrent} = ${res}`);
        if (calcHistory.length > 10) calcHistory.pop();
        document.getElementById('calcHistory').innerHTML = calcHistory.map(h => `<div style="padding:2px; border-bottom:1px dashed #ccc;">${h}</div>`).join('');
      }
      calcCurrent = res === 'Error' ? 'Error' : res.toString();
      calcPrevious = ''; calcOperator = null; calcShouldReset = true;
      updateCalcDisplay();
    }

    // Account functions
    function changePassword() {
      if (currentUser?.providerData[0]?.providerId !== 'password') return showNotification('Hanya untuk email/password', 'warning');
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPasswordAccount').value = '';
      document.getElementById('confirmNewPasswordAccount').value = '';
      document.getElementById('changePasswordModal').style.display = 'flex';
    }

    async function submitChangePassword() {
      const old = document.getElementById('oldPassword').value;
      const neu = document.getElementById('newPasswordAccount').value;
      const conf = document.getElementById('confirmNewPasswordAccount').value;
      if (!old || !neu || !conf) return showNotification('Semua kolom wajib!', 'warning');
      if (neu !== conf) return showNotification('Password tidak cocok!', 'warning');
      if (neu.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, old);
        await currentUser.reauthenticateWithCredential(cred);
        await currentUser.updatePassword(neu);
        closeModal('changePasswordModal');
        showNotification('Password diubah!', 'success');
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function deleteAccount() {
      if (!confirm('YAKIN HAPUS AKUN? Semua data hilang!')) return;
      try {
        await db.collection('users').doc(currentUser.uid).delete();
        await currentUser.delete();
        showNotification('Akun dihapus!', 'success');
        setTimeout(() => { currentUser = null; showAuthPage(); }, 1500);
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') { showNotification('Login ulang!', 'warning'); await logout(); }
        else showNotification('Gagal: ' + e.message, 'error');
      }
    }

    function showNotification(text, type = 'success') {
      const n = document.getElementById('notification');
      n.textContent = text;
      n.className = `notif-${type} show`;
      setTimeout(() => n.classList.remove('show'), 3000);
    }

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'resetPassword' && params.get('oobCode')) {
        window.passwordResetCode = params.get('oobCode');
        history.replaceState({}, '', window.location.pathname);
        setTimeout(() => {
          document.getElementById('authPage').style.display = 'none';
          document.getElementById('resetPasswordPage').style.display = 'block';
        }, 100);
      }
      
      // Setup navigation
      document.querySelectorAll('.nav-item').forEach(item => {
        item.addEventListener('click', () => {
          switchPage(item.dataset.page);
        });
      });
      
      auth.onAuthStateChanged(async user => {
        if (user) { 
          currentUser = user; 
          showApp(); 
          await loadUserData(); 
        } else {
          showAuthPage();
        }
      });
      
      // Initialize calculator
      updateCalcDisplay();
    });

    // Prevent double tap zoom
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);

    // Keyboard shortcuts for calculator
    document.addEventListener('keydown', e => {
      if (currentPage !== 'kalkulator') return;
      if (e.key >= '0' && e.key <= '9') calcInput(e.key);
      else if (e.key === '.') calcInput('.');
      else if (e.key === '+') calcInput('+');
      else if (e.key === '-') calcInput('-');
      else if (e.key === '*') calcInput('Ã—');
      else if (e.key === '/') { e.preventDefault(); calcInput('Ã·'); }
      else if (e.key === '%') calcInput('%');
      else if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calcCalculate(); }
      else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') calcClear();
      else if (e.key === 'Backspace') calcBackspace();
    });
  </script>
</body>
</html>