<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <meta name="mobile-web-app-capable" content="yes"/>
  <meta name="apple-mobile-web-app-capable" content="yes"/>
  <meta name="theme-color" content="#FFF5D7"/>
  <title>Inventaris Barang</title>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyB0q9aSR1-MZkbJ0woYiqQI6il6oeoEWUo",
      authDomain: "inventory-2ab17.firebaseapp.com",
      projectId: "inventory-2ab17",
      storageBucket: "inventory-2ab17.firebasestorage.app",
      messagingSenderId: "1085281663088",
      appId: "1:1085281663088:web:a65f8c29b07a224ccf9cb5",
      measurementId: "G-0PKKSLJ6TB"
    };

    let app;
    try { app = firebase.initializeApp(firebaseConfig); } 
    catch (e) { if (!firebase.apps.length) app = firebase.initializeApp(firebaseConfig); }

    const auth = firebase.auth();
    const db = firebase.firestore();
    const googleProvider = new firebase.auth.GoogleAuthProvider();
    googleProvider.setCustomParameters({ prompt: 'select_account' });
  </script>

  <style>
    :root {
      --bg-color: #FFF5D7;
      --card-bg: #FFFFFF;
      --border-color: #000000;
      --text-main: #000000;
      --primary: #4D96FF;
      --primary-hover: #2E72E2;
      --success: #6BCB77;
      --danger: #FF6B6B;
      --warning: #FFD93D;
      --shadow-hard: 4px 4px 0px 0px var(--border-color);
      --shadow-hard-sm: 2px 2px 0px 0px var(--border-color);      --border-thick: 2px solid var(--border-color);
      --transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
    }

    * { 
      margin: 0; 
      padding: 0; 
      box-sizing: border-box; 
      font-family: 'Courier New', monospace; 
      -webkit-tap-highlight-color: transparent;
      touch-action: manipulation;
    }
    
    body {
      background-color: var(--bg-color);
      background-image: radial-gradient(var(--border-color) 1px, transparent 1px);
      background-size: 20px 20px;
      min-height: 100vh;
      padding: 15px;
      color: var(--text-main);
      font-weight: bold;
      overflow-x: hidden;
      font-size: 14px;
    }

    h1, h2, h3, .title, .btn, .nav-link {
      font-family: 'Arial Black', 'Helvetica Neue', sans-serif;
      text-transform: uppercase;
      letter-spacing: -0.5px;
    }

    .container { 
      max-width: 100%; 
      margin: 0 auto; 
      width: 100%;
      padding: 0 5px;
    }

    #authPage, #forgotPasswordPage, #resetPasswordPage {
      background: var(--card-bg);
      padding: 1.5rem;
      border: var(--border-thick);
      box-shadow: var(--shadow-hard);
      text-align: center;
      width: 100%;
      max-width: 400px;
      margin: 20px auto;
      animation: slideUp 0.3s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
    .logo { font-size: 2.5rem; margin-bottom: 1rem; color: var(--text-main); animation: bounce 2s infinite; }
    @keyframes bounce { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-5px); } }
    
    h1 { font-size: 1.5rem; margin-bottom: 1.2rem; border-bottom: var(--border-thick); padding-bottom: 0.5rem; display: inline-block; }
    
    .input-group { margin-bottom: 1rem; text-align: left; }
    label {
      display: block; margin-bottom: 0.4rem; font-weight: 800; font-size: 0.85rem;
      background: var(--text-main); color: var(--card-bg); display: inline-block; padding: 2px 6px;
    }
    input[type="email"], input[type="password"], input[type="text"], input[type="number"], input[type="date"] {
      width: 100%; padding: 0.7rem; border: var(--border-thick); background: #f0f0f0;
      font-family: 'Courier New', monospace; font-weight: bold; font-size: 16px;
      outline: none; box-shadow: inset 2px 2px 0px 0px rgba(0,0,0,0.1); transition: var(--transition);
    }
    input:focus { background: #fff; border-color: var(--primary); box-shadow: 2px 2px 0px 0px var(--primary); }

    .btn {
      display: block; width: 100%; padding: 0.7rem; background: var(--primary); color: white;
      border: var(--border-thick); font-size: 0.9rem; font-weight: 800; cursor: pointer;
      margin-top: 0.5rem; box-shadow: var(--shadow-hard-sm); transition: var(--transition);
      text-align: center; text-decoration: none; position: relative; overflow: hidden;
      min-height: 44px;
    }
    .btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px 0px var(--border-color); }
    .btn:hover { filter: brightness(1.1); }
    .btn-secondary { background: #A0A0A0; color: white; }
    .btn-google { background: #FF6B6B; color: white; }
    .btn-cancel { background: white; color: var(--text-main); }

    .nav-wrapper {
      position: relative;
      margin-bottom: 1rem;
      background: var(--card-bg);
      border: var(--border-thick);
      box-shadow: var(--shadow-hard);
      overflow: hidden;
    }
    
    .nav-scroll {
      display: flex;
      gap: 3px;
      padding: 4px;
      overflow-x: auto;
      scroll-behavior: smooth;
      -ms-overflow-style: none;
      scrollbar-width: none;
    }
    .nav-scroll::-webkit-scrollbar { display: none; }    
    .nav-btn {
      flex: 0 0 auto;
      padding: 0.5rem 0.8rem;
      background: transparent;
      color: var(--text-main);
      border: var(--border-thick);
      font-size: 0.7rem;
      font-weight: 800;
      cursor: pointer;
      transition: var(--transition);
      display: flex;
      align-items: center;
      gap: 0.3rem;
      white-space: nowrap;
      min-height: 40px;
    }
    
    .nav-btn.active {
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow-hard-sm);
    }
    
    .nav-arrow {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      width: 25px;
      height: 100%;
      background: var(--card-bg);
      border: var(--border-thick);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      z-index: 10;
      font-size: 0.7rem;
    }
    .nav-arrow.left { left: 0; border-right: none; }
    .nav-arrow.right { right: 0; border-left: none; }
    .nav-arrow.hidden { display: none; }

    #app { display: none; flex-direction: column; }
    
    header {
      display: flex; justify-content: space-between; align-items: center;
      padding: 0.8rem 1rem; background: var(--card-bg); border: var(--border-thick);
      box-shadow: var(--shadow-hard); margin-bottom: 0.8rem;
    }    .title { font-size: 1rem; display: flex; align-items: center; gap: 0.5rem; }
    .logout-btn {
      background: none; border: none; color: var(--text-main); font-size: 1.1rem;
      cursor: pointer; padding: 5px; min-width: 44px; min-height: 44px;
    }
    .logout-btn:hover { border: 2px solid var(--danger); color: var(--danger); border-radius: 50%; }

    .content-section { display: none; }
    .content-section.active { display: block; }

    #fabButton {
      position: fixed; bottom: 20px; right: 15px; width: 50px; height: 50px;
      background: var(--success); color: white; border: var(--border-thick);
      display: none; align-items: center; justify-content: center; font-size: 1.5rem;
      box-shadow: var(--shadow-hard); cursor: pointer; z-index: 100; 
      border-radius: 50%; min-width: 50px; min-height: 50px;
    }
    #fabButton.show { display: flex !important; }
    #fabButton:active { transform: translate(4px, 4px); box-shadow: none; }

    .modal-backdrop {
      display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
      background: rgba(0,0,0,0.8); z-index: 999; justify-content: center; align-items: center;
      padding: 10px;
    }
    .modal, .modal-confirm {
      background: var(--card-bg); border: var(--border-thick);
      box-shadow: 8px 8px 0px 0px var(--text-main);
      width: 95%; max-width: 500px; max-height: 85vh; overflow-y: auto;
      padding: 1.2rem; position: relative;
    }
    .modal-confirm { max-width: 380px; text-align: center; }
    .modal-header {
      display: flex; justify-content: space-between; align-items: center;
      margin-bottom: 1.2rem; padding-bottom: 0.8rem; border-bottom: var(--border-thick);
    }
    .modal-title { font-size: 1.2rem; font-weight: 900; }
    .modal-close {
      background: var(--danger); color: white; border: var(--border-thick);
      width: 30px; height: 30px; display: flex; align-items: center; justify-content: center;
      cursor: pointer; font-weight: bold; border-radius: 50%;
    }

    .table-container {
      background: var(--card-bg); border: var(--border-thick);
      box-shadow: var(--shadow-hard); overflow: hidden; margin-bottom: 1.5rem;
    }
    .table-container > div {
      background: var(--primary); color: white; padding: 0.8rem;
      border-bottom: var(--border-thick); display: flex; justify-content: space-between;      align-items: center; flex-wrap: wrap; gap: 8px;
    }
    .table-container h2 { font-size: 0.95rem; display: flex; align-items: center; gap: 0.5rem; }
    .table-actions { display: flex; gap: 0.4rem; }
    .table-actions .btn { width: auto; padding: 0.4rem 0.8rem; font-size: 0.75rem; }

    .bulk-action-bar {
      background: var(--danger);
      color: white;
      padding: 0.6rem 0.8rem;
      border-bottom: var(--border-thick);
      display: none;
      justify-content: space-between;
      align-items: center;
    }
    .bulk-action-bar.show { display: flex; }
    .bulk-info { font-size: 0.8rem; }
    .bulk-btn {
      background: white; color: var(--danger); border: 2px solid white;
      padding: 0.4rem 0.8rem; font-weight: 800; cursor: pointer;
      min-height: 36px;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      width: 100%;
    }

    table { 
      width: 100%; 
      border-collapse: collapse; 
      min-width: 600px;
      font-size: 0.85rem;
    }
    th, td { 
      padding: 0.6rem 0.4rem; 
      text-align: left; 
      border-bottom: 2px solid black;
      white-space: nowrap;
    }
    th { 
      background: #000 !important; 
      color: #fff !important; 
      font-weight: 900; 
      text-transform: uppercase; 
      font-size: 0.8rem;
      position: sticky; 
      top: 0;
      z-index: 10;    }
    td { background: #fff !important; color: #000 !important; }
    tr:nth-child(odd) td { background: #f9f9f9 !important; }
    tr:hover td { background: #e6f3ff !important; }
    
    .custom-checkbox {
      width: 24px; height: 24px;
      border: 2px solid black;
      background: white;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }
    .custom-checkbox.checked { background: var(--danger); }
    .custom-checkbox i { color: white; font-size: 12px; display: none; }
    .custom-checkbox.checked i { display: block; }

    .col-harga { text-align: right; color: #00aa00 !important; font-weight: 700; }
    .col-total { text-align: right; color: #0066cc !important; font-weight: 900; }

    .btn-action {
      width: 32px; height: 32px; border: var(--border-thick); background: white;
      display: flex; align-items: center; justify-content: center; cursor: pointer;
      margin: 0 0.2rem; min-width: 32px; min-height: 32px;
    }
    .btn-edit { color: var(--primary); }
    .btn-edit:hover { background: var(--primary); color: white; }
    .btn-delete { color: var(--danger); }
    .btn-delete:hover { background: var(--danger); color: white; }

    .empty-state { text-align: center; padding: 2rem 1rem; color: #666; }
    .empty-state i { font-size: 2.5rem; margin-bottom: 0.8rem; }

    .account-card {
      background: var(--card-bg); border: var(--border-thick);
      box-shadow: var(--shadow-hard); padding: 1.5rem; text-align: center;
    }
    .account-avatar {
      width: 80px; height: 80px; border-radius: 50%; 
      background: linear-gradient(135deg, var(--primary), var(--success));
      color: white; display: flex; align-items: center; justify-content: center;
      font-size: 2rem; margin: 0 auto 0.8rem; border: var(--border-thick);
    }
    .account-info { margin: 1.2rem 0; text-align: left; max-width: 100%; }
    .account-info p { 
      margin: 0.6rem 0; padding: 0.6rem; 
      background: #f9f9f9; border-left: 4px solid var(--primary);
      font-size: 0.85rem;
    }    .account-actions { display: flex; gap: 0.5rem; margin-top: 1.2rem; justify-content: center; flex-wrap: wrap; }
    .account-actions .btn { width: auto; min-width: 140px; }

    .calculator-card {
      background: var(--card-bg);
      border: var(--border-thick);
      box-shadow: var(--shadow-hard);
      padding: 1.2rem;
      max-width: 100%;
    }
    .calc-display {
      background: #1a1a1a;
      color: #00ff00;
      font-size: 1.3rem;
      padding: 0.8rem;
      border: var(--border-thick);
      text-align: right;
      margin-bottom: 0.8rem;
      min-height: 50px;
    }
    .calc-expression { font-size: 0.8rem; color: #888; text-align: right; }
    .calc-buttons { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; }
    .calc-btn {
      padding: 0.8rem; font-size: 1.1rem; font-weight: 800;
      border: var(--border-thick); background: var(--card-bg);
      cursor: pointer; min-height: 44px;
    }
    .calc-btn.operator { background: var(--primary); color: white; }
    .calc-btn.equals { background: var(--success); color: white; grid-column: span 2; }
    .calc-btn.clear { background: var(--danger); color: white; }
    .calc-btn.zero { grid-column: span 2; }
    .calc-shortcuts { margin-top: 1.2rem; padding-top: 0.8rem; border-top: var(--border-thick); }
    .shortcut-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.4rem; }
    .shortcut-btn {
      padding: 0.5rem; font-size: 0.7rem; background: #f0f0f0;
      border: var(--border-thick); cursor: pointer; min-height: 36px;
    }
    .calc-history {
      margin-top: 1.2rem; max-height: 120px; overflow-y: auto;
      border: var(--border-thick); padding: 0.4rem; background: #f9f9f9; font-size: 0.8rem;
    }
    .calc-history-item { padding: 0.25rem 0; border-bottom: 1px dashed #ccc; cursor: pointer; }
    .calc-history-item:hover { background: var(--primary); color: white; }

    #notification {
      position: fixed; top: 10px; right: 10px; padding: 0.8rem 1.2rem;
      border: var(--border-thick); font-weight: 900; 
      box-shadow: 4px 4px 0px 0px black;
      transform: translateX(200%); transition: transform 0.3s;
      z-index: 1000; max-width: 90%; font-size: 0.85rem;    }
    #notification.show { transform: translateX(0); }
    .notif-success { background: var(--success); color: white; }
    .notif-error { background: var(--danger); color: white; }
    .notif-warning { background: var(--warning); color: black; }

    @media (max-width: 768px) {
      #fabButton { bottom: 70px; }
      table { min-width: 550px; font-size: 0.8rem; }
      th, td { padding: 0.5rem 0.3rem; font-size: 0.8rem; }
      .nav-btn { padding: 0.45rem 0.7rem; font-size: 0.65rem; }
      .calc-btn { padding: 0.7rem; font-size: 1rem; }
      .bulk-action-bar { flex-direction: column; align-items: flex-start; }
      .bulk-btn { width: 100%; }
      .table-container > div { flex-direction: column; align-items: flex-start; }
      .table-actions { width: 100%; }
    }

    @media (max-width: 480px) {
      body { font-size: 13px; padding: 8px; }
      table { min-width: 520px; font-size: 0.75rem; }
      th, td { padding: 0.45rem 0.25rem; }
      .btn-action { width: 28px; height: 28px; min-width: 28px; min-height: 28px; }
    }

    .hidden { display: none !important; }
  </style>
</head>
<body>

  <div id="authPage" class="container">
    <div class="logo"><i class="fas fa-box-open"></i></div>
    <div style="display: flex; gap: 0.8rem; margin-bottom: 1.2rem;">
      <button id="tabLogin" class="btn" onclick="showTab('login')">üîê MASUK</button>
      <button id="tabSignup" class="btn btn-secondary" onclick="showTab('signup')">‚úçÔ∏è DAFTAR</button>
    </div>
    <div id="loginForm">
      <h1>üöÄ MASUK</h1>
      <div class="input-group">
        <label>üìß EMAIL</label>
        <input type="email" id="emailLogin" placeholder="USER@EMAIL.COM">
      </div>
      <div class="input-group">
        <label>üîë PASSWORD</label>
        <input type="password" id="passwordLogin" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      </div>
      <button class="btn" onclick="loginWithEmail()">‚ö° LOGIN</button>
      <button class="btn btn-secondary" onclick="forgotPassword()">üóùÔ∏è LUPA PASSWORD?</button>
      <button class="btn btn-google" onclick="signInWithGoogle()">üî¥ GOOGLE</button>
    </div>    <div id="signupForm" style="display: none;">
      <h1>‚ú® DAFTAR</h1>
      <div class="input-group">
        <label>üìß EMAIL</label>
        <input type="email" id="emailSignup" placeholder="USER@EMAIL.COM">
      </div>
      <div class="input-group">
        <label>üîë PASSWORD</label>
        <input type="password" id="passwordSignup" placeholder="Minimal 6 karakter">
      </div>
      <div class="input-group">
        <label>‚úÖ KONFIRMASI</label>
        <input type="password" id="confirmPassword" placeholder="Ulangi password">
      </div>
      <button class="btn" onclick="signUpWithEmail()">üéâ DAFTAR</button>
    </div>
  </div>

  <div id="forgotPasswordPage" class="container" style="display: none;">
    <div class="logo"><i class="fas fa-key"></i></div>
    <h1>üîÑ RESET</h1>
    <div class="input-group">
      <label>üìß EMAIL</label>
      <input type="email" id="fpEmail" placeholder="USER@EMAIL.COM">
    </div>
    <button class="btn" onclick="sendPasswordResetLink()">üì§ KIRIM</button>
    <button class="btn btn-secondary" onclick="showAuthPage()">‚¨ÖÔ∏è KEMBALI</button>
  </div>

  <div id="resetPasswordPage" class="container" style="display: none;">
    <div class="logo"><i class="fas fa-lock-open"></i></div>
    <h1>üîì PASSWORD BARU</h1>
    <div class="input-group">
      <label>üîë PASSWORD</label>
      <input type="password" id="newPassword" placeholder="Minimal 6 karakter">
    </div>
    <div class="input-group">
      <label>‚úÖ KONFIRMASI</label>
      <input type="password" id="confirmNewPassword" placeholder="Ulangi password">
    </div>
    <button class="btn" onclick="confirmPasswordReset()">üíæ SIMPAN</button>
    <button class="btn btn-secondary" onclick="showAuthPage()">‚¨ÖÔ∏è KEMBALI</button>
  </div>

  <div id="app" class="container">
    <header>
      <div class="title" id="userDisplayName"><i class="fas fa-warehouse"></i> INVENTARIS</div>
      <button class="logout-btn" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
    </header>
    <div class="nav-wrapper">
      <button class="nav-arrow left hidden" onclick="scrollNav(-200)"><i class="fas fa-chevron-left"></i></button>
      <div class="nav-scroll" id="navScroll">
        <button class="nav-btn active" onclick="switchTab('dataBarang', this)">üì¶ Data</button>
        <button class="nav-btn" onclick="switchTab('akumulasi', this)">üìä Akumulasi</button>
        <button class="nav-btn" onclick="switchTab('kalkulator', this)">üßÆ Kalkulator</button>
        <button class="nav-btn" onclick="switchTab('account', this)">üë§ Account</button>
      </div>
      <button class="nav-arrow right hidden" onclick="scrollNav(200)"><i class="fas fa-chevron-right"></i></button>
    </div>

    <section id="dataBarang" class="content-section active">
      <div class="table-container">
        <div id="bulkActionBar" class="bulk-action-bar">
          <div class="bulk-info"><i class="fas fa-check-circle"></i> <span id="bulkCount">0</span> DIPILIH</div>
          <button class="bulk-btn" onclick="deleteSelected()">üóëÔ∏è HAPUS</button>
        </div>
        <div>
          <h2><i class="fas fa-clipboard-list"></i> DAFTAR BARANG</h2>
          <div class="table-actions">
            <button class="btn" style="background: var(--success);" onclick="downloadCSV()">CSV</button>
            <button class="btn" style="background: #6c5ce7;" onclick="exportToPNG()">PNG</button>
          </div>
        </div>
        <div class="table-wrapper">
          <table id="dataTable">
            <thead>
              <tr>
                <th style="width:40px;text-align:center;"><div class="custom-checkbox" onclick="toggleSelectAll()" id="selectAllCheckbox"><i class="fas fa-check"></i></div></th>
                <th>No</th><th>Barang</th><th>Jml</th><th>Harga</th><th>Total</th><th>Tanggal</th><th>Aksi</th>
              </tr>
            </thead>
            <tbody id="dataBody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <section id="akumulasi" class="content-section">
      <div class="table-container">
        <div style="background: var(--warning); color: #000;">
          <h2><i class="fas fa-calculator"></i> TOTAL AKUMULASI</h2>
        </div>
        <div class="table-wrapper">
          <table id="summaryTable">
            <thead><tr><th>BARANG</th><th>TOTAL</th><th>NILAI</th></tr></thead>
            <tbody id="summaryBody"></tbody>
            <tfoot id="summaryFooter" style="background:#000!important;color:#e040fb!important;"></tfoot>
          </table>
        </div>      </div>
    </section>

    <section id="kalkulator" class="content-section">
      <div class="calculator-card">
        <h2 style="text-align:center;margin-bottom:0.8rem;">üßÆ KALKULATOR</h2>
        <div class="calc-expression" id="calcExpression"></div>
        <div class="calc-display" id="calcDisplay">0</div>
        <div class="calc-buttons">
          <button class="calc-btn clear" onclick="calcClear()">AC</button>
          <button class="calc-btn" onclick="calcBackspace()">‚å´</button>
          <button class="calc-btn operator" onclick="calcInput('%')">%</button>
          <button class="calc-btn operator" onclick="calcInput('√∑')">√∑</button>
          <button class="calc-btn" onclick="calcInput('7')">7</button>
          <button class="calc-btn" onclick="calcInput('8')">8</button>
          <button class="calc-btn" onclick="calcInput('9')">9</button>
          <button class="calc-btn operator" onclick="calcInput('√ó')">√ó</button>
          <button class="calc-btn" onclick="calcInput('4')">4</button>
          <button class="calc-btn" onclick="calcInput('5')">5</button>
          <button class="calc-btn" onclick="calcInput('6')">6</button>
          <button class="calc-btn operator" onclick="calcInput('-')">‚àí</button>
          <button class="calc-btn" onclick="calcInput('1')">1</button>
          <button class="calc-btn" onclick="calcInput('2')">2</button>
          <button class="calc-btn" onclick="calcInput('3')">3</button>
          <button class="calc-btn operator" onclick="calcInput('+')">+</button>
          <button class="calc-btn zero" onclick="calcInput('0')">0</button>
          <button class="calc-btn" onclick="calcInput('.')">.</button>
          <button class="calc-btn equals" onclick="calcCalculate()">=</button>
        </div>
        <div class="calc-shortcuts">
          <div class="shortcut-grid">
            <button class="shortcut-btn" onclick="calcShortcut('totalQty')">üì¶ Total Qty</button>
            <button class="shortcut-btn" onclick="calcShortcut('totalValue')">üí∞ Total Nilai</button>
            <button class="shortcut-btn" onclick="calcShortcut('ppn')">üßæ +PPN 11%</button>
            <button class="shortcut-btn" onclick="calcShortcut('diskon10')">üè∑Ô∏è Diskon 10%</button>
          </div>
        </div>
        <div class="calc-history" id="calcHistory"><div style="text-align:center;color:#666;">Riwayat kosong</div></div>
      </div>
    </section>

    <section id="account" class="content-section">
      <div class="account-card">
        <div class="account-avatar" id="accountAvatar"><i class="fas fa-user"></i></div>
        <h2 id="accountName">User</h2>
        <p id="accountEmail" style="color:#666;">email</p>
        <div class="account-info">
          <p><i class="fas fa-calendar"></i> <span id="accountJoined">-</span></p>
          <p><i class="fas fa-database"></i> <span id="accountTotalData">0</span> item</p>
        </div>        <div class="account-actions">
          <button class="btn btn-secondary" onclick="changePassword()">üîê Ubah Password</button>
          <button class="btn" style="background:var(--danger);" onclick="deleteAccount()">üóëÔ∏è Hapus Akun</button>
        </div>
      </div>
    </section>
  </div>

  <div id="fabButton" onclick="openAddModal()"><i class="fas fa-plus"></i></div>

  <!-- MODALS -->
  <div id="addModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">TAMBAH BARANG</div><button class="modal-close" onclick="closeModal('addModal')">X</button></div>
      <div class="input-group"><label>NAMA</label><input type="text" id="namaBarangInput"></div>
      <div class="input-group"><label>JUMLAH</label><input type="number" id="jumlahInput" min="1"></div>
      <div class="input-group"><label>HARGA</label><input type="number" id="hargaInput" min="0"></div>
      <div class="input-group"><label>TANGGAL</label><input type="date" id="tanggalInput"></div>
      <div style="display:flex;gap:0.5rem;"><button class="btn" onclick="tambahData()">SIMPAN</button><button class="btn btn-cancel" onclick="closeModal('addModal')">BATAL</button></div>
    </div>
  </div>

  <div id="editModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">EDIT</div><button class="modal-close" onclick="closeModal('editModal')">X</button></div>
      <input type="hidden" id="editIndex">
      <div class="input-group"><label>NAMA</label><input type="text" id="editNama"></div>
      <div class="input-group"><label>JUMLAH</label><input type="number" id="editJumlah" min="1"></div>
      <div class="input-group"><label>HARGA</label><input type="number" id="editHarga" min="0"></div>
      <div class="input-group"><label>TANGGAL</label><input type="date" id="editTanggal"></div>
      <div style="display:flex;gap:0.5rem;"><button class="btn" onclick="updateData()">SIMPAN</button><button class="btn btn-cancel" onclick="closeModal('editModal')">BATAL</button></div>
    </div>
  </div>

  <div id="confirmModal" class="modal-backdrop">
    <div class="modal-confirm">
      <div class="modal-title" style="color:var(--danger);">HAPUS?</div>
      <p style="margin:0.8rem 0;">‚ö†Ô∏è Tidak dapat dibatalkan!</p>
      <div style="display:flex;gap:0.5rem;"><button class="btn btn-cancel" onclick="closeModal('confirmModal')">BATAL</button><button class="btn" style="background:var(--danger);" onclick="confirmDelete()">HAPUS</button></div>
    </div>
  </div>

  <div id="confirmBulkModal" class="modal-backdrop">
    <div class="modal-confirm">
      <div class="modal-title" style="color:var(--danger);">HAPUS <span id="bulkConfirmCount">0</span> DATA?</div>
      <p style="margin:0.8rem 0;">‚ö†Ô∏è Tidak dapat dibatalkan!</p>
      <div style="display:flex;gap:0.5rem;"><button class="btn btn-cancel" onclick="closeModal('confirmBulkModal')">BATAL</button><button class="btn" style="background:var(--danger);" onclick="confirmBulkDelete()">HAPUS</button></div>
    </div>
  </div>
  <div id="changePasswordModal" class="modal-backdrop">
    <div class="modal">
      <div class="modal-header"><div class="modal-title">UBAH PASSWORD</div><button class="modal-close" onclick="closeModal('changePasswordModal')">X</button></div>
      <div class="input-group"><label>PASSWORD LAMA</label><input type="password" id="oldPassword"></div>
      <div class="input-group"><label>PASSWORD BARU</label><input type="password" id="newPasswordAccount"></div>
      <div class="input-group"><label>KONFIRMASI</label><input type="password" id="confirmNewPasswordAccount"></div>
      <div style="display:flex;gap:0.5rem;"><button class="btn" onclick="submitChangePassword()">SIMPAN</button><button class="btn btn-cancel" onclick="closeModal('changePasswordModal')">BATAL</button></div>
    </div>
  </div>

  <div id="notification"></div>

  <script>
    let currentUser = null, barangData = [], deleteIndex = null, currentTab = 'dataBarang';
    let selectedIndices = new Set();
    let calcCurrent = '0', calcPrevious = '', calcOperator = null, calcShouldReset = false, calcHistory = [];

    function scrollNav(amount) {
      const nav = document.getElementById('navScroll');
      nav.scrollBy({ left: amount, behavior: 'smooth' });
      updateNavArrows();
    }

    function updateNavArrows() {
      const nav = document.getElementById('navScroll');
      document.querySelector('.nav-arrow.left').classList.toggle('hidden', nav.scrollLeft <= 0);
      document.querySelector('.nav-arrow.right').classList.toggle('hidden', nav.scrollLeft + nav.clientWidth >= nav.scrollWidth - 10);
    }

    function switchTab(tabName, btn) {
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      if (btn) btn.classList.add('active');
      document.querySelectorAll('.content-section').forEach(s => s.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      document.getElementById('fabButton').classList.toggle('show', tabName === 'dataBarang');
      currentTab = tabName;
      updateNavArrows();
      if (tabName === 'akumulasi') renderSummaryTable();
      if (tabName === 'account') updateAccountInfo();
      if (tabName === 'kalkulator') initCalculator();
    }

    function showTab(tab) {
      document.getElementById('loginForm').style.display = tab === 'login' ? 'block' : 'none';
      document.getElementById('signupForm').style.display = tab === 'signup' ? 'block' : 'none';
      document.getElementById('tabLogin').classList.toggle('btn-secondary', tab !== 'login');
      document.getElementById('tabSignup').classList.toggle('btn-secondary', tab !== 'signup');
    }

    function showAuthPage() {      document.getElementById('authPage').style.display = 'block';
      document.getElementById('forgotPasswordPage').style.display = 'none';
      document.getElementById('resetPasswordPage').style.display = 'none';
      document.getElementById('app').style.display = 'none';
      document.getElementById('fabButton').classList.remove('show');
    }

    async function signUpWithEmail() {
      const email = document.getElementById('emailSignup').value.trim();
      const pass = document.getElementById('passwordSignup').value;
      const pass2 = document.getElementById('confirmPassword').value;
      if (!email || !pass) return showNotification('Email & password wajib!', 'warning');
      if (pass !== pass2) return showNotification('Password tidak cocok!', 'warning');
      if (pass.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        await auth.createUserWithEmailAndPassword(email, pass);
        showNotification('Akun berhasil dibuat!', 'success');
        showTab('login');
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function loginWithEmail() {
      const email = document.getElementById('emailLogin').value.trim();
      const pass = document.getElementById('passwordLogin').value;
      if (!email || !pass) return showNotification('Email & password wajib!', 'warning');
      try {
        await auth.signInWithEmailAndPassword(email, pass);
        showNotification('Selamat datang!', 'success');
        setTimeout(showApp, 600);
        await loadUserData();
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function signInWithGoogle() {
      try {
        const result = await auth.signInWithPopup(googleProvider);
        currentUser = result.user;
        const docRef = db.collection('users').doc(currentUser.uid);
        if (!(await docRef.get()).exists) await docRef.set({ barangData: [] });
        showNotification('Selamat datang!', 'success');
        setTimeout(showApp, 600);
        await loadUserData();
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function logout() {
      await auth.signOut();
      currentUser = null; barangData = []; selectedIndices.clear();
      showNotification('Keluar berhasil', 'success');
      setTimeout(showAuthPage, 500);    }

    function forgotPassword() {
      const email = document.getElementById('emailLogin').value.trim();
      if (email) document.getElementById('fpEmail').value = email;
      showAuthPage();
      setTimeout(() => {
        document.getElementById('authPage').style.display = 'none';
        document.getElementById('forgotPasswordPage').style.display = 'block';
      }, 300);
    }

    async function sendPasswordResetLink() {
      const email = document.getElementById('fpEmail').value.trim();
      if (!email) return showNotification('Masukkan email!', 'warning');
      try {
        await auth.sendPasswordResetEmail(email);
        showNotification('Tautan dikirim!', 'success');
        setTimeout(showAuthPage, 2000);
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function confirmPasswordReset() {
      const newPassword = document.getElementById('newPassword').value;
      const confirmNewPassword = document.getElementById('confirmNewPassword').value;
      const oobCode = window.passwordResetCode;
      if (!oobCode) return showNotification('Sesi kadaluarsa!', 'error');
      if (!newPassword || !confirmNewPassword) return showNotification('Semua kolom wajib!', 'warning');
      if (newPassword !== confirmNewPassword) return showNotification('Password tidak cocok!', 'warning');
      if (newPassword.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        await auth.confirmPasswordReset(oobCode, newPassword);
        showNotification('Password diubah!', 'success');
        setTimeout(() => { window.passwordResetCode = null; showAuthPage(); }, 2000);
      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function loadUserData() {
      if (!currentUser) return;
      try {
        const doc = await db.collection('users').doc(currentUser.uid).get();
        barangData = doc.exists && doc.data().barangData ? doc.data().barangData : [];
        selectedIndices.clear();
        renderTable();
        renderSummaryTable();
        updateBulkActionBar();
      } catch (e) { showNotification('Gagal memuat data', 'error'); }
    }

    async function saveUserData() {      if (!currentUser) return;
      try {
        barangData.sort((a, b) => new Date(a.tanggal) - new Date(b.tanggal));
        await db.collection('users').doc(currentUser.uid).set({ barangData }, { merge: true });
        renderTable();
        renderSummaryTable();
        updateBulkActionBar();
      } catch (e) { showNotification('Gagal menyimpan', 'error'); }
    }

    function showApp() {
      document.getElementById('authPage').style.display = 'none';
      document.getElementById('app').style.display = 'flex';
      document.getElementById('fabButton').classList.add('show');
      const user = currentUser;
      document.getElementById('userDisplayName').innerHTML = `<i class="fas fa-warehouse"></i> ${user.displayName || user.email}`;
      document.getElementById('tanggalInput').valueAsDate = new Date();
      document.getElementById('editTanggal').valueAsDate = new Date();
      updateAccountInfo();
      updateNavArrows();
    }

    function updateAccountInfo() {
      if (!currentUser) return;
      document.getElementById('accountName').textContent = currentUser.displayName || currentUser.email;
      document.getElementById('accountEmail').textContent = currentUser.email;
      document.getElementById('accountJoined').textContent = currentUser.metadata?.creationTime ? new Date(currentUser.metadata.creationTime).toLocaleDateString('id-ID') : '-';
      document.getElementById('accountTotalData').textContent = barangData.length;
    }

    function openAddModal() {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      document.getElementById('namaBarangInput').value = '';
      document.getElementById('jumlahInput').value = '';
      document.getElementById('hargaInput').value = '';
      document.getElementById('tanggalInput').valueAsDate = new Date();
      document.getElementById('addModal').style.display = 'flex';
    }

    function closeModal(id) { document.getElementById(id).style.display = 'none'; }

    async function tambahData() {
      const nama = document.getElementById('namaBarangInput').value.trim();
      const jumlah = parseInt(document.getElementById('jumlahInput').value);
      const harga = parseInt(document.getElementById('hargaInput').value) || 0;
      const tanggal = document.getElementById('tanggalInput').value;
      if (!nama) return showNotification('Nama wajib!', 'warning');
      if (!jumlah || jumlah <= 0) return showNotification('Jumlah harus > 0!', 'warning');
      if (!tanggal) return showNotification('Tanggal wajib!', 'warning');
      barangData.push({ nama, jumlah, harga, tanggal });      await saveUserData();
      closeModal('addModal');
      showNotification('Data ditambahkan!', 'success');
    }

    async function updateData() {
      const index = parseInt(document.getElementById('editIndex').value);
      const nama = document.getElementById('editNama').value.trim();
      const jumlah = parseInt(document.getElementById('editJumlah').value);
      const harga = parseInt(document.getElementById('editHarga').value) || 0;
      const tanggal = document.getElementById('editTanggal').value;
      if (!nama) return showNotification('Nama wajib!', 'warning');
      if (!jumlah || jumlah <= 0) return showNotification('Jumlah harus > 0!', 'warning');
      if (!tanggal) return showNotification('Tanggal wajib!', 'warning');
      barangData[index] = { nama, jumlah, harga, tanggal };
      await saveUserData();
      closeModal('editModal');
      showNotification('Data diperbarui!', 'success');
    }

    function openConfirmDelete(index) {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      deleteIndex = index;
      document.getElementById('confirmModal').style.display = 'flex';
    }

    async function confirmDelete() {
      if (deleteIndex !== null) {
        barangData.splice(deleteIndex, 1);
        await saveUserData();
        closeModal('confirmModal');
        showNotification('Data dihapus!', 'warning');
        deleteIndex = null;
      }
    }

    function openEditModal(index) {
      if (!currentUser) return showNotification('Login dulu!', 'warning');
      const item = barangData[index];
      document.getElementById('editIndex').value = index;
      document.getElementById('editNama').value = item.nama;
      document.getElementById('editJumlah').value = item.jumlah;
      document.getElementById('editHarga').value = item.harga || 0;
      document.getElementById('editTanggal').value = item.tanggal;
      document.getElementById('editModal').style.display = 'flex';
    }

    function toggleSelect(index) {
      selectedIndices.has(index) ? selectedIndices.delete(index) : selectedIndices.add(index);
      renderTable();      updateBulkActionBar();
    }

    function toggleSelectAll() {
      if (selectedIndices.size === barangData.length && barangData.length > 0) selectedIndices.clear();
      else barangData.forEach((_, i) => selectedIndices.add(i));
      renderTable();
      updateBulkActionBar();
    }

    function updateBulkActionBar() {
      const bar = document.getElementById('bulkActionBar');
      document.getElementById('bulkCount').textContent = selectedIndices.size;
      bar.classList.toggle('show', selectedIndices.size > 0);
      document.getElementById('selectAllCheckbox').classList.toggle('checked', selectedIndices.size === barangData.length && barangData.length > 0);
    }

    function deleteSelected() {
      if (selectedIndices.size === 0) return;
      document.getElementById('bulkConfirmCount').textContent = selectedIndices.size;
      document.getElementById('confirmBulkModal').style.display = 'flex';
    }

    async function confirmBulkDelete() {
      const indices = Array.from(selectedIndices).sort((a, b) => b - a);
      indices.forEach(i => barangData.splice(i, 1));
      selectedIndices.clear();
      await saveUserData();
      closeModal('confirmBulkModal');
      showNotification(`${indices.length} data dihapus!`, 'success');
    }

    function formatRupiah(angka) {
      return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(angka);
    }

    function renderTable() {
      const tbody = document.getElementById('dataBody');
      if (!barangData.length) {
        tbody.innerHTML = `<tr><td colspan="8" class="empty-state"><i class="fas fa-inbox"></i><div>Belum ada data</div></td></tr>`;
        return;
      }
      tbody.innerHTML = barangData.map((item, i) => {
        const total = (item.jumlah || 0) * (item.harga || 0);
        const isSelected = selectedIndices.has(i);
        return `<tr style="${isSelected ? 'background:#ffe6e6!important;' : ''}">
          <td style="text-align:center;"><div class="custom-checkbox ${isSelected ? 'checked' : ''}" onclick="toggleSelect(${i})"><i class="fas fa-check"></i></div></td>
          <td>${i + 1}</td><td><strong>${item.nama}</strong></td><td>${item.jumlah}</td>
          <td class="col-harga">${formatRupiah(item.harga || 0)}</td>
          <td class="col-total">${formatRupiah(total)}</td>          <td>${new Date(item.tanggal).toLocaleDateString('id-ID')}</td>
          <td><button class="btn-action btn-edit" onclick="openEditModal(${i})"><i class="fas fa-edit"></i></button><button class="btn-action btn-delete" onclick="openConfirmDelete(${i})"><i class="fas fa-trash"></i></button></td>
        </tr>`;
      }).join('');
    }

    function renderSummaryTable() {
      const tbody = document.getElementById('summaryBody');
      const tfoot = document.getElementById('summaryFooter');
      if (!barangData.length) {
        tbody.innerHTML = `<tr><td colspan="3" class="empty-state"><i class="fas fa-chart-pie"></i><div>Belum ada data</div></td></tr>`;
        tfoot.innerHTML = '';
        return;
      }
      const map = {};
      let grandTotal = 0;
      barangData.forEach(item => {
        const key = item.nama.trim().toLowerCase();
        const val = (item.jumlah || 0) * (item.harga || 0);
        grandTotal += val;
        if (!map[key]) map[key] = { nama: item.nama, qty: 0, nilai: 0 };
        map[key].qty += item.jumlah || 0;
        map[key].nilai += val;
      });
      tbody.innerHTML = Object.entries(map).sort((a, b) => a[1].nama.localeCompare(b[1].nama)).map(([_, d]) => 
        `<tr><td><strong>${d.nama}</strong></td><td style="color:var(--primary);font-weight:900">${d.qty}</td><td class="col-total">${formatRupiah(d.nilai)}</td></tr>`
      ).join('');
      tfoot.innerHTML = `<tr><td>TOTAL</td><td>-</td><td class="col-total" style="color:##e040fb!important">${formatRupiah(grandTotal)}</td></tr>`;
    }

    function downloadCSV() {
      if (!barangData.length) return showNotification('Tidak ada data!', 'error');
      let csv = 'No,Nama,Jumlah,Harga,Total,Tanggal\n';
      barangData.forEach((item, i) => {
        const total = (item.jumlah || 0) * (item.harga || 0);
        csv += `${i + 1},${item.nama},${item.jumlah},${item.harga || 0},${total},${item.tanggal}\n`;
      });
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = `inventaris_${new Date().toISOString().slice(0,10)}.csv`;
      a.click(); URL.revokeObjectURL(url);
      showNotification('File diunduh!', 'success');
    }

    function exportToPNG() {
      if (!barangData.length) return showNotification('Tidak ada data!', 'error');
      const div = document.createElement('div');
      div.style.cssText = 'padding:20px;background:white;position:absolute;left:-9999px;';
      div.innerHTML = `<h2>DAFTAR BARANG</h2>${document.getElementById('dataTable').outerHTML}`;
      document.body.appendChild(div);      html2canvas(div, { scale: 2 }).then(canvas => {
        const a = document.createElement('a'); a.download = `inventaris_${new Date().toISOString().slice(0,10)}.png`;
        a.href = canvas.toDataURL(); a.click();
        document.body.removeChild(div);
        showNotification('PNG diunduh!', 'success');
      }).catch(() => { showNotification('Gagal membuat PNG', 'error'); document.body.removeChild(div); });
    }

    function initCalculator() {
      calcCurrent = '0'; calcPrevious = ''; calcOperator = null; calcShouldReset = false;
      updateCalcDisplay();
    }

    function updateCalcDisplay() {
      document.getElementById('calcDisplay').textContent = formatCalcNumber(calcCurrent);
      document.getElementById('calcExpression').textContent = calcOperator ? `${formatCalcNumber(calcPrevious)} ${calcOperator}` : '';
    }

    function formatCalcNumber(n) {
      const num = parseFloat(n);
      if (isNaN(num)) return n;
      return num.toLocaleString('id-ID');
    }

    function calcInput(val) {
      if (calcShouldReset && !['+', '-', '√ó', '√∑', '%'].includes(val)) { calcCurrent = ''; calcShouldReset = false; }
      if (['+', '-', '√ó', '√∑', '%'].includes(val)) {
        if (calcOperator && !calcShouldReset) calcCalculate(false);
        calcPrevious = calcCurrent; calcOperator = val; calcShouldReset = true;
      } else if (val === '.') {
        if (!calcCurrent.includes('.')) calcCurrent += '.';
      } else {
        calcCurrent = calcCurrent === '0' ? val : calcCurrent + val;
      }
      updateCalcDisplay();
    }

    function calcClear() { calcCurrent = '0'; calcPrevious = ''; calcOperator = null; calcShouldReset = false; updateCalcDisplay(); }
    function calcBackspace() { calcCurrent = calcCurrent.length > 1 ? calcCurrent.slice(0, -1) : '0'; updateCalcDisplay(); }

    function calcCalculate(updateHistory = true) {
      if (!calcOperator || !calcPrevious) return;
      const a = parseFloat(calcPrevious), b = parseFloat(calcCurrent);
      let res;
      switch(calcOperator) {
        case '+': res = a + b; break;
        case '-': res = a - b; break;
        case '√ó': res = a * b; break;
        case '√∑': res = b !== 0 ? a / b : 'Error'; break;
        case '%': res = a * (b / 100); break;      }
      if (updateHistory && res !== 'Error') {
        calcHistory.unshift(`${calcPrevious} ${calcOperator} ${calcCurrent} = ${res}`);
        if (calcHistory.length > 10) calcHistory.pop();
        document.getElementById('calcHistory').innerHTML = calcHistory.map(h => `<div class="calc-history-item" onclick="calcUseHistory('${h}')">${h}</div>`).join('');
      }
      calcCurrent = res === 'Error' ? 'Error' : res.toString();
      calcPrevious = ''; calcOperator = null; calcShouldReset = true;
      updateCalcDisplay();
    }

    function calcUseHistory(entry) {
      const res = entry.split('=')[1]?.trim();
      if (res) { calcCurrent = res; calcShouldReset = true; updateCalcDisplay(); }
    }

    function calcShortcut(type) {
      if (!barangData.length) return showNotification('Tidak ada data!', 'warning');
      let val;
      switch(type) {
        case 'totalQty': val = barangData.reduce((s, i) => s + (i.jumlah || 0), 0); break;
        case 'totalValue': val = barangData.reduce((s, i) => s + ((i.jumlah || 0) * (i.harga || 0)), 0); break;
        case 'ppn': val = (parseFloat(calcCurrent) || 0) * 1.11; break;
        case 'diskon10': val = (parseFloat(calcCurrent) || 0) * 0.9; break;
      }
      calcCurrent = val.toString(); calcShouldReset = true; updateCalcDisplay();
      showNotification('Shortcut diterapkan!', 'success');
    }

    function changePassword() {
      if (currentUser?.providerData[0]?.providerId !== 'password') return showNotification('Hanya untuk email/password', 'warning');
      document.getElementById('oldPassword').value = '';
      document.getElementById('newPasswordAccount').value = '';
      document.getElementById('confirmNewPasswordAccount').value = '';
      document.getElementById('changePasswordModal').style.display = 'flex';
    }

    async function submitChangePassword() {
      const old = document.getElementById('oldPassword').value;
      const neu = document.getElementById('newPasswordAccount').value;
      const conf = document.getElementById('confirmNewPasswordAccount').value;
      if (!old || !neu || !conf) return showNotification('Semua kolom wajib!', 'warning');
      if (neu !== conf) return showNotification('Password tidak cocok!', 'warning');
      if (neu.length < 6) return showNotification('Password minimal 6 karakter!', 'warning');
      try {
        const cred = firebase.auth.EmailAuthProvider.credential(currentUser.email, old);
        await currentUser.reauthenticateWithCredential(cred);
        await currentUser.updatePassword(neu);
        closeModal('changePasswordModal');
        showNotification('Password diubah!', 'success');      } catch (e) { showNotification('Gagal: ' + e.message, 'error'); }
    }

    async function deleteAccount() {
      if (!confirm('YAKIN HAPUS AKUN? Semua data hilang!')) return;
      try {
        await db.collection('users').doc(currentUser.uid).delete();
        await currentUser.delete();
        showNotification('Akun dihapus!', 'success');
        setTimeout(() => { currentUser = null; showAuthPage(); }, 1500);
      } catch (e) {
        if (e.code === 'auth/requires-recent-login') { showNotification('Login ulang!', 'warning'); await logout(); }
        else showNotification('Gagal: ' + e.message, 'error');
      }
    }

    function showNotification(text, type = 'success') {
      const n = document.getElementById('notification');
      n.textContent = text;
      n.className = `notif-${type} show`;
      setTimeout(() => n.classList.remove('show'), 3000);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const params = new URLSearchParams(window.location.search);
      if (params.get('mode') === 'resetPassword' && params.get('oobCode')) {
        window.passwordResetCode = params.get('oobCode');
        history.replaceState({}, '', window.location.pathname);
        setTimeout(() => {
          document.getElementById('authPage').style.display = 'none';
          document.getElementById('resetPasswordPage').style.display = 'block';
        }, 100);
      }
      auth.onAuthStateChanged(async user => {
        if (user) { currentUser = user; showApp(); await loadUserData(); }
        else showAuthPage();
      });
      setTimeout(updateNavArrows, 100);
      window.addEventListener('resize', updateNavArrows);
    });

    window.addEventListener('orientationchange', () => setTimeout(() => window.scrollTo(0, 0), 200));
    let lastTouchEnd = 0;
    document.addEventListener('touchend', e => {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) e.preventDefault();
      lastTouchEnd = now;
    }, false);

    document.addEventListener('keydown', e => {      if (currentTab !== 'kalkulator') return;
      if (e.key >= '0' && e.key <= '9') calcInput(e.key);
      else if (e.key === '.') calcInput('.');
      else if (e.key === '+') calcInput('+');
      else if (e.key === '-') calcInput('-');
      else if (e.key === '*') calcInput('√ó');
      else if (e.key === '/') { e.preventDefault(); calcInput('√∑'); }
      else if (e.key === '%') calcInput('%');
      else if (e.key === 'Enter' || e.key === '=') { e.preventDefault(); calcCalculate(); }
      else if (e.key === 'Escape' || e.key === 'c' || e.key === 'C') calcClear();
      else if (e.key === 'Backspace') calcBackspace();
    });
  </script>
</body>
</html>